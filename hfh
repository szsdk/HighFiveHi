#!/usr/bin/env python3
import click
from pathlib import Path
import h5py
import IPython

__doc__ = """This command reads hdf5 files then puts them in a list `f`."""


def process_file(files, mode):
    h5files = []
    scripts = []
    for i in map(Path, files):
        if i.suffix == ".h5":
            h5files.append(h5py.File(i, mode))
        else:
            scripts.append(i.absolute())
    return h5files, scripts


def load_scripts(scripts):
    ns = dict()
    for s in scripts:
        with s.open() as fp:
            exec(fp.read(), ns)
    return ns


@click.command(help=__doc__)
@click.argument("files", nargs=-1)
@click.option("--mode", "-m", help="The append mode", default="r")
def cli(files, mode):
    hf, scripts = process_file(files, mode)
    ns = load_scripts(scripts)
    ns["hf"] = hf[0] if len(hf) == 1 else hf

    print("Try: print(hf)\n")
    IPython.start_ipython(["--pylab", "--no-banner"], user_ns=ns)

    for i in hf:
        i.close()


if __name__ == "__main__":
    cli()
